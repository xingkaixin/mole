# Mole 数据库分析工具 - 技术架构文档

## 项目概述

Mole 是一个基于 Wails v2.10.2 框架开发的桌面应用程序，专注于数据库表的自动化分析和元数据管理。该工具采用现代化前后端分离架构，前端使用 React 18.3.1 + TypeScript 5.8.3，后端使用 Go 1.23，通过 Wails 提供的绑定机制实现前后端通信。

## 整体架构

### 架构模式
- **桌面应用架构**: 基于 Wails v2.10.2 框架
- **前后端分离**: React 前端 + Go 后端
- **本地存储**: SQLite 作为内部数据存储
- **并发处理**: Go 协程池处理分析任务 (最大5个并发)
- **任务管理**: 完整的任务生命周期管理
- **元数据管理**: 数据库字典功能

### 技术栈

#### 前端技术栈
- **React 18.3.1**: 用户界面框架
- **TypeScript 5.8.3**: 类型安全的 JavaScript
- **Vite 6.3.5**: 快速构建工具和开发服务器
- **Tailwind CSS 4.1.8**: 实用优先的 CSS 框架
- **Shadcn UI**: 可访问的 UI 组件库 (New York风格)
- **Biome 2.2.4**: 代码格式化和检查工具
- **Radix UI**: 无障碍设计系统
- **Lucide React 0.511.0**: 图标库
- **Sonner 2.0.5**: 通知组件

#### 后端技术栈
- **Go 1.23**: 后端开发语言
- **Wails v2.10.2**: 桌面应用开发框架
- **MySQL Driver v1.8.1**: 数据库连接驱动
- **SQLite v1.14.32**: 本地数据存储
- **UUID v1.6.0**: 唯一标识符生成
- **标准库**: context, sync, database/sql 等

#### 开发工具链
- **Bun**: 包管理器
- **Make**: 构建脚本
- **跨平台构建**: Windows、macOS通用

## 核心模块设计

### 1. 应用入口模块 (main.go)
**文件**: main.go (56行)

**功能**: Wails应用启动入口，配置应用基本信息和生命周期
```go
func main() {
    app := backend.NewApp()
    wails.Run(&options.App{
        Title:  "Mole",
        Width:  1024,
        Height: 768,
        AssetServer: &assetserver.Options{Assets: assets},
        BackgroundColour: &options.RGBA{R: 27, G: 38, B: 54, A: 1},
        OnStartup: app.Startup,
        OnBeforeClose: func(ctx context.Context) (prevent bool) {
            // 应用关闭前的清理工作
            logger := backend.GetLogger()
            if logger != nil {
                logger.Close()
            }
            return false
        },
        Bind: []interface{}{app},
    })
}
```


### 2. 应用核心模块 (backend/app.go)
**文件**: backend/app.go

**职责**: 应用程序核心控制器，管理各个子模块，提供完整的API接口

**核心组件**:
```go
type App struct {
    ctx            context.Context
    dbManager      *DatabaseManager      // 数据库连接管理
    analysisEngine *AnalysisEngine       // 分析引擎
    storageManager *StorageManager       // 存储管理
    currentConfig  *DatabaseConfig       // 当前数据库配置
    taskManager    *TaskManager          // 任务管理器
}
```

**主要功能模块**:
1. **数据库连接管理**: 测试、连接、获取表列表
2. **分析任务管理**: 启动、状态查询、取消、结果获取
3. **存储管理**: 连接配置、表选择、分析结果持久化
4. **元数据管理**: 数据库字典更新、表/列信息查询
5. **任务系统**: 任务CRUD、表关联管理、分析执行

### 3. 数据库管理模块 (backend/database.go)
**文件**: backend/database.go

**职责**: 处理外部数据库连接和操作，专注于MySQL数据库

**核心功能**:
- 数据库连接管理 (MySQL)
- 连接测试和验证
- 表结构查询和元数据获取
- 表统计信息 (行数、数据大小、列数、注释)

**数据结构**:
```go
type DatabaseConfig struct {
    ID          string `json:"id"`
    Name        string `json:"name"`
    Type        string `json:"type"`
    Host        string `json:"host"`
    Port        int    `json:"port"`
    Username    string `json:"username"`
    Password    string `json:"password"`
    Database    string `json:"database"`
    Concurrency int    `json:"concurrency"` // 并发度配置
}

type TableMetadata struct {
    TableName   string           `json:"tableName"`
    Comment     string           `json:"comment"`
    DataSize    int64            `json:"dataSize"`
    RowCount    int64            `json:"rowCount"`
    ColumnCount int              `json:"columnCount"`
    Columns     []ColumnMetadata `json:"columns"`
}

type ColumnMetadata struct {
    ColumnName    string `json:"columnName"`
    ColumnComment string `json:"columnComment"`
    ColumnOrdinal int    `json:"columnOrdinal"`
    ColumnType    string `json:"columnType"`
}
```

**关键方法**:
- `Connect()`: 建立数据库连接
- `TestConnection()`: 测试连接有效性
- `GetTables()`: 获取数据库表清单
- `GetTableMetadata()`: 获取单个表的元数据
- `GetAllTablesMetadata()`: 获取所有表的完整元数据

### 4. 分析引擎模块 (backend/analysis.go)
**文件**: backend/analysis.go

**职责**: 实现数据表分析规则，采用策略模式支持扩展

**设计模式**: 策略模式 (Strategy Pattern)

**核心接口**:
```go
type AnalysisRule interface {
    GetName() string
    GetDescription() string
    Execute(ctx context.Context, db *sql.DB, tableName string, config *DatabaseConfig) (interface{}, error)
}
```

**内置规则**:
- `RowCountRule`: 统计表行数
  ```go
  func (r *RowCountRule) Execute(ctx context.Context, db *sql.DB, tableName string, config *DatabaseConfig) (interface{}, error) {
      var rowCount int64
      err := db.QueryRowContext(ctx, fmt.Sprintf("SELECT COUNT(*) FROM %s", tableName)).Scan(&rowCount)
      return rowCount, err
  }
  ```

- `NonNullRateRule`: 计算列非空值率 (高性能优化版本)
  ```go
  func (r *NonNullRateRule) Execute(ctx context.Context, db *sql.DB, tableName string, config *DatabaseConfig) (interface{}, error) {
      // 单次查询计算所有列的非空值率
      var selectParts []string
      for _, column := range columns {
          selectParts = append(selectParts, fmt.Sprintf("1 - AVG(%s IS NULL) as %s", column, column))
      }
      sqlQuery := fmt.Sprintf("SELECT %s FROM %s", strings.Join(selectParts, ", "), tableName)
      // 执行查询并返回结果
  }
  ```

**非空值率计算优化**:
- **优化前**: N列需要2N+1次查询 (SELECT COUNT(*) + N次SELECT COUNT(column))
- **优化后**: 单次查询完成所有列计算
- **核心原理**: 利用MySQL布尔表达式特性 `true=1, false=0`
  ```sql
  SELECT 1-AVG(column1 IS NULL), 1-AVG(column2 IS NULL), ... FROM table_name
  ```
- **性能提升**: 查询次数从O(N)降至O(1)，显著提升大表分析速度

**分析引擎结构**:
```go
type AnalysisEngine struct {
    rules map[string]AnalysisRule
}
```

### 5. 任务管理模块 (backend/task.go)
**文件**: backend/task.go

**职责**: 并发任务调度和管理，实现完整的任务生命周期

**设计模式**: 工作池模式 (Worker Pool Pattern)

**核心组件**:
```go
type TaskManager struct {
    tasks          map[string]*AnalysisTask  // 任务存储
    mu             sync.RWMutex             // 读写锁
    maxWorkers     int                      // 最大工作线程数 (默认5)
    taskQueue      chan *AnalysisTask       // 任务队列 (缓冲1000)
    workers        chan struct{}            // 工作信号量
    ctx            context.Context          // 全局上下文
    cancel         context.CancelFunc       // 全局取消函数
    analysisEngine *AnalysisEngine          // 分析引擎引用
    dbManager      *DatabaseManager         // 数据库管理器引用
    storageManager *StorageManager          // 存储管理器引用
}
```

**任务状态流转**:
```go
const (
    TaskStatusPending   TaskStatus = "pending"
    TaskStatusRunning   TaskStatus = "running"
    TaskStatusCompleted TaskStatus = "completed"
    TaskStatusFailed    TaskStatus = "failed"
    TaskStatusCancelled TaskStatus = "cancelled"
)
```

**任务数据结构**:
```go
type AnalysisTask struct {
    ID             string             `json:"id"`
    TableName      string             `json:"table_name"`
    DatabaseID     string             `json:"database_id"`
    DatabaseConfig *DatabaseConfig    `json:"database_config"`
    Status         TaskStatus         `json:"status"`
    Progress       float64            `json:"progress"` // 0-100
    ErrorMessage   string             `json:"error_message"`
    StartedAt      *time.Time         `json:"started_at"`
    CompletedAt    *time.Time         `json:"completed_at"`
    Duration       time.Duration      `json:"duration"`
    Result         interface{}        `json:"result"`
    TaskID         string             `json:"task_id"`       // 任务ID
    TableID        string             `json:"table_id"`      // 表ID
    TaskTableID    string             `json:"task_table_id"` // 任务表关联ID
    ctx            context.Context    `json:"-"`
    cancel         context.CancelFunc `json:"-"`
}
```

**任务取消机制**:
- 每个任务创建独立的context和cancel函数
- 支持用户手动取消和120秒超时自动取消
- context取消传播到SQL查询层，立即中断数据库操作
- 任务状态实时同步，前端显示准确的取消状态

**关键功能**:
- `AddTask()`: 添加任务到队列
- `CancelTask()`: 取消正在执行的任务
- `GetTask()`: 获取任务状态
- `CreateAnalysisTasksForTable()`: 为表创建分析任务
- `UpdateTaskTableStatus()`: 更新任务表状态

### 6. 存储管理模块 (backend/storage.go)
**文件**: backend/storage.go

**职责**: 本地数据持久化，实现完整的数据存储和管理

**存储技术**: SQLite v1.14.32
**跨平台支持**: Windows、macOS、Linux
**数据目录**:
- Windows: %APPDATA%\Mole
- macOS: ~/Library/Application Support/Mole
- Linux: ~/.local/share/mole

**数据表设计**:
```sql
-- 数据库连接配置表
CREATE TABLE database_connections (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL,
    host TEXT NOT NULL,
    port INTEGER NOT NULL,
    username TEXT NOT NULL,
    password TEXT NOT NULL,
    database TEXT NOT NULL,
    concurrency INTEGER DEFAULT 5,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 表选择状态表
CREATE TABLE table_selections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    connection_id TEXT NOT NULL,
    table_name TEXT NOT NULL,
    selected BOOLEAN NOT NULL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(connection_id, table_name)
);

-- 分析结果表
CREATE TABLE analysis_results (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    table_id TEXT NOT NULL,
    table_name TEXT NOT NULL,
    rules TEXT NOT NULL,
    results TEXT NOT NULL,
    status TEXT NOT NULL,
    started_at DATETIME NOT NULL,
    completed_at DATETIME,
    duration INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(task_id, table_id)
);

-- 元数据-表
CREATE TABLE metadata_tables (
    id TEXT PRIMARY KEY,
    connection_id TEXT NOT NULL,
    table_name TEXT NOT NULL,
    table_comment TEXT,
    table_size INTEGER DEFAULT 0,
    row_count INTEGER DEFAULT 0,
    column_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(connection_id, table_name)
);

-- 元数据-列
CREATE TABLE metadata_columns (
    id TEXT PRIMARY KEY,
    table_id TEXT NOT NULL,
    column_name TEXT NOT NULL,
    column_comment TEXT,
    column_ordinal INTEGER NOT NULL,
    column_type TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(table_id, column_name)
);

-- 任务信息表
CREATE TABLE tasks_info (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 任务表关联表
CREATE TABLE tasks_tbls (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    table_id TEXT NOT NULL,
    tbl_status TEXT NOT NULL DEFAULT '待分析',
    added_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**核心数据结构**:
```go
type AnalysisResult struct {
    ID          string                 `json:"id"`
    DatabaseID  string                 `json:"databaseId"`
    TableName   string                 `json:"tableName"`
    Rules       []string               `json:"rules"`
    Results     map[string]interface{} `json:"results"`
    Status      string                 `json:"status"`
    StartedAt   time.Time              `json:"startedAt"`
    CompletedAt *time.Time             `json:"completedAt,omitempty"`
    Duration    time.Duration          `json:"duration"`
}

type TaskInfo struct {
    ID          string `json:"id"`
    Name        string `json:"name"`
    Description string `json:"description"`
    Status      string `json:"status"`
    CreatedAt   string `json:"createdAt"`
    UpdatedAt   string `json:"updatedAt"`
}

type TaskTableDetail struct {
    ID             string `json:"id"`
    TaskID         string `json:"taskId"`
    TableID        string `json:"tableId"`
    AddedAt        string `json:"addedAt"`
    TblStatus      string `json:"tblStatus"`
    ConnectionID   string `json:"connectionId"`
    ConnectionName string `json:"connectionName"`
    TableName      string `json:"tableName"`
    TableComment   string `json:"tableComment"`
    RowCount       int64  `json:"rowCount"`
    TableSize      int64  `json:"tableSize"`
    ColumnCount    int    `json:"columnCount"`
}
```

**关键功能**:
- 连接配置CRUD操作
- 分析结果存储和查询
- 元数据管理 (表和列)
- 任务和表关联管理
- 增强分析结果支持

### 7. 连接池模块 (backend/connection_pool.go)
**文件**: backend/connection_pool.go

**职责**: 数据库连接池管理，优化连接使用

**连接池结构**:
```go
type ConnectionPool struct {
    config      *DatabaseConfig
    connections chan *sql.DB
    mu          sync.RWMutex
    maxSize     int
    currentSize int
}

type ConnectionPoolManager struct {
    pools map[string]*ConnectionPool
    mu    sync.RWMutex
}
```

**关键特性**:
- 连接复用和管理
- 连接有效性检查
- 自动重连机制
- 连接池统计信息
- 资源清理控制
- 当前实现尚未在 `App` 或 `TaskManager` 中启用，后续集成时需与现有 `DatabaseManager` 的连接生命周期对齐。

### 8. 日志系统模块 (backend/logger.go)
**文件**: backend/logger.go

**职责**: 统一的日志记录系统，支持跨平台文件日志

**日志级别**:
```go
const (
    TRACE LogLevel = iota
    DEBUG
    INFO
    WARN
    ERROR
    FATAL
)
```

**跨平台日志目录**:
- **macOS**: ~/Library/Logs/mole/
- **Windows**: %APPDATA%\mole\logs\
- **Linux**: ~/.local/share/mole/logs/

**核心功能**:
- 文件日志和控制台输出
- 模块化日志记录
- 用户操作日志记录
- 系统事件日志记录
- 应用生命周期日志

**前端日志集成**:
```typescript
// 前端通过Wails调用后端日志系统
import { LogFrontendAction } from '../../wailsjs/go/backend/App';

export function logUserAction(module: string, action: string, details: string): void {
  LogFrontendAction(module, action, details);
}
```

## 前端架构

### 1. 应用入口 (App.tsx)
**文件**: frontend/src/App.tsx

**职责**: 整体应用状态管理和路由控制

**核心状态**:
```typescript
const [currentStep, setCurrentStep] = useState<AppStep>("welcome");
const [previousStep, setPreviousStep] = useState<AppStep | null>(null);
const [connections, setConnections] = useState<DatabaseConfig[]>([]);
const [currentConnection, setCurrentConnection] = useState<DatabaseConfig | null>(null);
const [currentAnalysisResult, setCurrentAnalysisResult] = useState<any | null>(null);
const [dbConfig, setDbConfig] = useState<DatabaseConfig>({
  id: "",
  name: "",
  type: "mysql",
  host: "localhost",
  port: 3306,
  username: "root",
  password: "",
  database: "",
  concurrency: 5,
});
const [connectionStatus, setConnectionStatus] = useState("");
const [_tables, setTables] = useState<TableInfo[]>([]);
const [_selectedTables, setSelectedTables] = useState<string[]>([]);
const [_analysisResults, _setAnalysisResults] = useState<RuleResult[]>([]);
const [isAddingConnection, setIsAddingConnection] = useState(false);
```

**应用流程状态**:
```typescript
export type AppStep =
  | "welcome"
  | "config"
  | "analysis_tables"
  | "table_selection"
  | "analysis"
  | "results"
  | "tasks"
  | "analysis_detail";
```

**核心功能**:
- 数据库连接CRUD操作
- 连接状态管理
- 表选择和分析流程控制
- 任务管理集成
- 状态持久化到后端

### 2. 页面组件

#### WelcomePage (欢迎页面)
**文件**: frontend/src/pages/WelcomePage.tsx

**功能特性**:
- 数据库连接卡片展示
- 搜索和过滤功能 (按名称、主机、数据库类型)
- 连接管理操作 (编辑、复制、删除、更新元数据)
- 响应式网格布局

**过滤逻辑**:
```typescript
const filteredConnections = useMemo(() => {
  return connections.filter((connection) => {
    const searchMatch = !filters.searchText ||
      connection.name.toLowerCase().includes(filters.searchText.toLowerCase()) ||
      connection.host.toLowerCase().includes(filters.searchText.toLowerCase()) ||
      connection.database.toLowerCase().includes(filters.searchText.toLowerCase());
    const typeMatch = filters.type === "all" || connection.type === filters.type;
    return searchMatch && typeMatch;
  });
}, [connections, filters]);
```

#### TaskManagementPage (任务管理页面)
**文件**: frontend/src/pages/TaskManagementPage.tsx

**核心功能**:
- 任务创建和管理
- 表添加和移除
- 分析执行和取消
- 实时状态轮询 (3秒间隔)
- 分析结果查看

**状态轮询机制**:
```typescript
useEffect(() => {
  if (!selectedTaskId) return;
  const interval = setInterval(async () => {
    await loadTaskTables(selectedTaskId);
  }, 3000); // 每3秒刷新一次
  return () => clearInterval(interval);
}, [selectedTaskId, loadTaskTables]);
```

#### ConfigPage (配置页面)
**文件**: frontend/src/pages/ConfigPage.tsx
**简洁封装**: 使用DatabaseConfigForm组件实现具体功能

#### AnalysisDetailPage (分析详情页面)
**文件**: frontend/src/pages/AnalysisDetailPage.tsx

**功能特性**:
- 支持增强分析结果和基本结果
- 列信息展示 (序号、列名、类型、注释、非空值率)
- 搜索过滤功能
- 响应式表格布局

### 3. 核心组件

#### Sidebar (侧边栏)
**文件**: frontend/src/components/Sidebar.tsx

**简洁设计**:
- 首页导航
- 任务管理导航
- 统一的日志记录

#### DatabaseCard (数据库卡片)
**文件**: frontend/src/components/database-card.tsx

**功能丰富**:
- 连接信息展示
- 下拉菜单操作 (编辑、复制、更新字典、删除)
- 元数据更新状态指示
- 操作日志记录

#### DatabaseConfigForm (数据库配置表单)
**文件**: frontend/src/components/forms/DatabaseConfigForm.tsx

**完整字段**:
- 连接别名
- 数据库类型 (固定为MySQL)
- 主机和端口
- 数据库名称
- 用户名和密码
- 并发度配置 (1-20)

#### CreateTaskDialog (创建任务对话框)
**文件**: frontend/src/components/create-task-dialog.tsx
**简洁交互**: 任务名称输入和创建

#### AddTableDialog (添加表对话框)
**文件**: frontend/src/components/add-table-dialog.tsx

**高级功能**:
- 连接选择
- 表搜索 (按名称和注释)
- 批量选择
- 已添加表标识
- 表统计信息展示

### 4. 类型定义系统
**文件**: frontend/src/types/index.ts

**核心接口**:
```typescript
export interface DatabaseConfig {
  id: string;
  name: string;
  type: string;
  host: string;
  port: number;
  username: string;
  password: string;
  database: string;
  concurrency: number;
}

export type TaskTable = {
  id: string;
  tableId: string;
  connectionId: string;
  connectionName: string;
  tableName: string;
  tableComment: string;
  rowCount: number;
  tableSize: number;
  columnCount: number;
  tblStatus: string; // 表状态：待分析｜分析中｜分析完成
  addedAt: string;
};

export type Task = {
  id: string;
  name: string;
  description: string;
  status: string;
  createdAt: string;
  updatedAt: string;
  tables: TaskTable[];
};
```

### 5. 日志系统
**文件**: frontend/src/lib/logger.ts

**统一日志记录**:
```typescript
export function createLogger(moduleName: string) {
  return {
    click: (buttonName: string) => logButtonClick(buttonName, moduleName),
    navigate: (fromPage: string, toPage: string) => logNavigation(fromPage, toPage),
    formSubmit: (formName: string, success: boolean, error?: string) => logFormSubmit(formName, success, error),
    databaseOperation: (operation: string, databaseName: string, success: boolean, details?: string) =>
      logDatabaseOperation(operation, databaseName, success, details),
    error: (operation: string, error: Error | string) => logError(moduleName, operation, error),
    info: (operation: string, message: string) => logInfo(moduleName, operation, message),
    userAction: (action: string, details: string) => logUserAction(moduleName, action, details),
  };
}
```

**后端集成**: 通过Wails绑定调用后端日志系统，确保前后端日志统一存储

### 6. UI 组件库
基于 Shadcn UI 构建 (New York风格)，包含16个组件：

**基础组件**:
- Button, Input, Card, Table
- Dialog, Badge, Progress
- Scroll-area, Dropdown-menu
- Select, Checkbox, Label
- Aspect-ratio

**配置文件**:
- **components.json**: Shadcn UI配置
- **tailwind.config.js**: Tailwind CSS配置
- **biome.json**: 代码质量配置

## 前后端通信

### Wails 绑定机制
后端 Go 方法自动绑定到前端 JavaScript：

```typescript
// 前端调用示例
import { ConnectDatabase, GetTables, StartAnalysisTasks } from "../wailsjs/go/backend/App.js";

const result = await ConnectDatabase(config);
const tables = await GetTables();
const taskId = await StartAnalysisTasks(connectionId, tables);
```

### 主要 API 接口

#### 数据库连接管理
- `TestDatabaseConnection(config)`: 测试连接
- `ConnectDatabase(config)`: 建立连接
- `GetDatabaseConnections()`: 获取连接列表
- `SaveDatabaseConnection(config)`: 保存连接配置
- `DeleteDatabaseConnection(id)`: 删除连接

#### 表操作
- `GetTables()`: 获取表清单
- `GetTablesMetadata(tableNames)`: 获取表元数据
- `GetTableSelections()`: 获取表选择状态
- `SaveTableSelections(tableNames)`: 保存表选择状态

#### 分析任务
- `StartAnalysisTasks(connectionId, tables)`: 启动分析任务
- `GetTaskStatus(taskId)`: 获取任务状态
- `GetTasksByDatabase(databaseId)`: 获取数据库任务列表
- `CancelTask(taskId)`: 取消任务 (立即中断SQL查询)

#### 分析结果
- `GetAnalysisResults(connectionId)`: 获取分析结果
- `DeleteAnalysisResult(resultId)`: 删除分析结果
- `GetAvailableRules()`: 获取可用规则列表

## 数据流架构

### 1. 连接建立流程
```
用户配置 -> 连接测试 -> 保存配置 -> 建立连接 -> 获取表列表
```

### 2. 分析执行流程
```
选择表 -> 创建任务 -> 任务队列 -> 并发执行 -> 结果存储 -> 状态更新
```

### 3. 结果查看流程
```
查询结果 -> 格式化展示 -> 交互操作 -> 删除/导出
```

## 并发处理架构

### 任务管理器设计
- **工作池大小**: 可配置 (默认 5)
- **任务队列**: 缓冲通道 (容量 1000)
- **并发控制**: 信号量模式
- **状态同步**: 读写锁保护

### 分析任务并发
```
TaskManager
    ├── Worker Pool (maxWorkers)
    ├── Task Queue (buffered channel)
    ├── Task Status Map
    └── Progress Tracking
```

## 错误处理架构

### 分层错误处理
1. **数据库层**: 连接失败、查询错误
2. **分析层**: 规则执行错误
3. **任务层**: 任务调度错误
4. **存储层**: 数据持久化错误
5. **前端层**: 用户交互错误

### 错误传播机制
- Go 层: 错误包装和上下文添加
- 前端层: 错误边界和用户友好提示
- 日志记录: 控制台输出和调试信息

## 性能优化策略

### 1. 数据库优化
- 连接池管理
- 查询优化
- 批量操作
- 索引利用
- **SQL查询取消**: context感知的查询中断机制

### 2. 并发优化
- 工作池限制
- 任务队列缓冲
- 进度异步更新
- 资源释放控制

### 3. 前端优化
- 组件懒加载
- 状态管理优化
- 虚拟滚动 (大列表)
- 防抖节流

## 安全考虑

### 1. 数据安全
- 密码本地存储加密
- 连接配置保护
- 敏感信息脱敏

### 2. 运行安全
- SQL 注入防护
- 连接数限制
- 资源使用监控

## 部署架构

### 构建流程
```bash
# 开发环境
make dev

# 生产构建
make build-mac    # macOS
make build-windows # Windows
```

### 打包结构
```
mole.app/
    ├── Contents/
    │   ├── MacOS/mole           # 可执行文件
    │   ├── Resources/           # 前端资源
    │   └── Info.plist          # 应用配置
```

## 扩展性设计

### 1. 规则扩展
- 插件化规则接口
- 动态规则注册
- 规则配置化

### 2. 数据库扩展
- 多数据库支持
- 连接类型抽象
- 驱动插件化

### 3. 分析扩展
- 自定义分析流程
- 结果格式配置
- 导出功能扩展

## 监控和调试

### 1. 日志系统
- 分级日志记录
- 文件日志输出
- 调试信息开关

### 2. 性能监控
- 任务执行时间
- 内存使用情况
- 连接池状态
- 队列长度监控

### 3. 调试工具
- 开发者工具集成
- 状态检查接口
- 错误追踪机制

这个架构设计确保了 Mole 应用的高性能、可扩展性和维护性，为数据库分析提供了稳定可靠的技术基础。