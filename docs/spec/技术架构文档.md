# Mole 数据库分析工具 - 技术架构文档

## 项目概述

Mole 是一个基于 Wails 框架开发的桌面应用程序，用于数据库表的自动化分析。该工具采用前后端分离架构，前端使用 React + TypeScript，后端使用 Go 语言，通过 Wails 提供的绑定机制实现前后端通信。

## 整体架构

### 架构模式
- **桌面应用架构**: 基于 Wails v2 框架
- **前后端分离**: React 前端 + Go 后端
- **本地存储**: SQLite 作为内部数据存储
- **并发处理**: Go 协程池处理分析任务

### 技术栈

#### 前端技术栈
- **React 18**: 用户界面框架
- **TypeScript**: 类型安全的 JavaScript
- **Vite**: 快速构建工具和开发服务器
- **Tailwind CSS**: 实用优先的 CSS 框架
- **Shadcn UI**: 可访问的 UI 组件库
- **Biome**: 代码格式化和检查工具
- **Radix UI**: 无障碍设计系统

#### 后端技术栈
- **Go 1.21+**: 后端开发语言
- **Wails v2**: 桌面应用开发框架
- **MySQL Driver**: 数据库连接驱动
- **SQLite**: 本地数据存储
- **标准库**: context, sync, database/sql 等

## 核心模块设计

### 1. 应用入口模块 (main.go)
```go
// 应用启动入口
func main() {
    app := backend.NewApp()
    wails.Run(&options.App{
        Title:  "Mole",
        Width:  1024,
        Height: 768,
        OnStartup: app.Startup,
        Bind: []interface{}{app},
    })
}
```

### 2. 应用核心模块 (backend/app.go)
**职责**: 应用程序核心控制器，管理各个子模块

**核心组件**:
- `DatabaseManager`: 数据库连接管理
- `AnalysisEngine`: 分析引擎
- `StorageManager`: 存储管理
- `TaskManager`: 任务管理器
- `currentConfig`: 当前数据库配置

### 3. 数据库管理模块 (backend/database.go)
**职责**: 处理外部数据库连接和操作

**核心功能**:
- 数据库连接管理 (MySQL)
- 连接测试和验证
- 表结构查询
- 表元数据获取 (行数、数据大小、列数、注释)

**数据结构**:
```go
type DatabaseConfig struct {
    ID          string `json:"id"`
    Name        string `json:"name"`
    Type        string `json:"type"`
    Host        string `json:"host"`
    Port        int    `json:"port"`
    Username    string `json:"username"`
    Password    string `json:"password"`
    Database    string `json:"database"`
    Concurrency int    `json:"concurrency"`
}
```

### 4. 分析引擎模块 (backend/analysis.go)
**职责**: 实现数据表分析规则

**设计模式**: 策略模式 (Strategy Pattern)

**核心接口**:
```go
type AnalysisRule interface {
    GetName() string
    GetDescription() string
    Execute(ctx context.Context, db *sql.DB, tableName string, config *DatabaseConfig) (interface{}, error)
}
```

**内置规则**:
- `RowCountRule`: 统计表行数
- `NonNullRateRule`: 计算列非空值率

**非空值率计算优化**:
- **优化前**: N列需要2N+1次查询 (SELECT COUNT(*) + N次SELECT COUNT(column))
- **优化后**: 单次查询完成所有列计算
- **核心原理**: 利用MySQL布尔表达式特性 `true=1, false=0`
  ```sql
  SELECT 1-AVG(column1 IS NULL), 1-AVG(column2 IS NULL), ... FROM table_name
  ```
- **性能提升**: 查询次数从O(N)降至O(1)，显著提升大表分析速度

### 5. 任务管理模块 (backend/task.go)
**职责**: 并发任务调度和管理

**设计模式**: 工作池模式 (Worker Pool Pattern)

**核心组件**:
- 任务队列 (缓冲通道)
- 工作池 (限制并发数)
- 任务状态管理
- 进度跟踪

**任务状态流转**:
```
pending -> running -> completed/failed/cancelled
```

**任务取消机制**:
- 每个任务创建独立的context和cancel函数
- 支持用户手动取消和120秒超时自动取消
- context取消传播到SQL查询层，立即中断数据库操作
- 任务状态实时同步，前端显示准确的取消状态

### 6. 存储管理模块 (backend/storage.go)
**职责**: 本地数据持久化

**存储技术**: SQLite
**跨平台支持**: Windows、macOS、Linux

**数据表设计**:
- `database_connections`: 数据库连接配置
- `table_selections`: 表选择状态
- `analysis_results`: 分析结果

### 7. 连接池模块 (backend/connection_pool.go)
**职责**: 数据库连接池管理，优化连接使用

## 前端架构

### 1. 应用入口 (App.tsx)
**职责**: 整体应用状态管理和路由控制

**核心状态**:
- `currentStep`: 当前页面步骤
- `connections`: 数据库连接列表
- `currentConnection`: 当前选中连接
- `selectedTables`: 选中的表列表
- `analysisResults`: 分析结果

### 2. 页面组件
- `WelcomePage`: 欢迎页面，连接管理
- `ConfigPage`: 数据库配置页面
- `AnalysisTablesPage`: 分析表选择页面
- `AnalysisPage`: 分析进度页面
- `ResultsPage`: 结果查看页面
- `AnalysisReportsPage`: 分析报告页面
- `TaskProgressPage`: 任务进度页面

### 3. 通用组件
- `Sidebar`: 侧边导航栏
- `DatabaseConfigForm`: 数据库配置表单
- `TableSelectionForm`: 表选择表单
- `AnalysisResultViewer`: 分析结果查看器
- `ResultsTable`: 结果表格

### 4. UI 组件库
基于 Shadcn UI 构建，包含：
- Button, Input, Card, Table
- Dialog, Badge, Progress
- Scroll-area, Dropdown-menu

## 前后端通信

### Wails 绑定机制
后端 Go 方法自动绑定到前端 JavaScript：

```typescript
// 前端调用示例
import { ConnectDatabase, GetTables, StartAnalysisTasks } from "../wailsjs/go/backend/App.js";

const result = await ConnectDatabase(config);
const tables = await GetTables();
const taskId = await StartAnalysisTasks(connectionId, tables);
```

### 主要 API 接口

#### 数据库连接管理
- `TestDatabaseConnection(config)`: 测试连接
- `ConnectDatabase(config)`: 建立连接
- `GetDatabaseConnections()`: 获取连接列表
- `SaveDatabaseConnection(config)`: 保存连接配置
- `DeleteDatabaseConnection(id)`: 删除连接

#### 表操作
- `GetTables()`: 获取表清单
- `GetTablesMetadata(tableNames)`: 获取表元数据
- `GetTableSelections()`: 获取表选择状态
- `SaveTableSelections(tableNames)`: 保存表选择状态

#### 分析任务
- `StartAnalysisTasks(connectionId, tables)`: 启动分析任务
- `GetTaskStatus(taskId)`: 获取任务状态
- `GetTasksByDatabase(databaseId)`: 获取数据库任务列表
- `CancelTask(taskId)`: 取消任务 (立即中断SQL查询)

#### 分析结果
- `GetAnalysisResults(connectionId)`: 获取分析结果
- `DeleteAnalysisResult(resultId)`: 删除分析结果
- `GetAvailableRules()`: 获取可用规则列表

## 数据流架构

### 1. 连接建立流程
```
用户配置 -> 连接测试 -> 保存配置 -> 建立连接 -> 获取表列表
```

### 2. 分析执行流程
```
选择表 -> 创建任务 -> 任务队列 -> 并发执行 -> 结果存储 -> 状态更新
```

### 3. 结果查看流程
```
查询结果 -> 格式化展示 -> 交互操作 -> 删除/导出
```

## 并发处理架构

### 任务管理器设计
- **工作池大小**: 可配置 (默认 5)
- **任务队列**: 缓冲通道 (容量 1000)
- **并发控制**: 信号量模式
- **状态同步**: 读写锁保护

### 分析任务并发
```
TaskManager
    ├── Worker Pool (maxWorkers)
    ├── Task Queue (buffered channel)
    ├── Task Status Map
    └── Progress Tracking
```

## 错误处理架构

### 分层错误处理
1. **数据库层**: 连接失败、查询错误
2. **分析层**: 规则执行错误
3. **任务层**: 任务调度错误
4. **存储层**: 数据持久化错误
5. **前端层**: 用户交互错误

### 错误传播机制
- Go 层: 错误包装和上下文添加
- 前端层: 错误边界和用户友好提示
- 日志记录: 控制台输出和调试信息

## 性能优化策略

### 1. 数据库优化
- 连接池管理
- 查询优化
- 批量操作
- 索引利用
- **SQL查询取消**: context感知的查询中断机制

### 2. 并发优化
- 工作池限制
- 任务队列缓冲
- 进度异步更新
- 资源释放控制

### 3. 前端优化
- 组件懒加载
- 状态管理优化
- 虚拟滚动 (大列表)
- 防抖节流

## 安全考虑

### 1. 数据安全
- 密码本地存储加密
- 连接配置保护
- 敏感信息脱敏

### 2. 运行安全
- SQL 注入防护
- 连接数限制
- 资源使用监控

## 部署架构

### 构建流程
```bash
# 开发环境
make dev

# 生产构建
make build-mac    # macOS
make build-windows # Windows
```

### 打包结构
```
mole.app/
    ├── Contents/
    │   ├── MacOS/mole           # 可执行文件
    │   ├── Resources/           # 前端资源
    │   └── Info.plist          # 应用配置
```

## 扩展性设计

### 1. 规则扩展
- 插件化规则接口
- 动态规则注册
- 规则配置化

### 2. 数据库扩展
- 多数据库支持
- 连接类型抽象
- 驱动插件化

### 3. 分析扩展
- 自定义分析流程
- 结果格式配置
- 导出功能扩展

## 监控和调试

### 1. 日志系统
- 分级日志记录
- 文件日志输出
- 调试信息开关

### 2. 性能监控
- 任务执行时间
- 内存使用情况
- 连接池状态
- 队列长度监控

### 3. 调试工具
- 开发者工具集成
- 状态检查接口
- 错误追踪机制

这个架构设计确保了 Mole 应用的高性能、可扩展性和维护性，为数据库分析提供了稳定可靠的技术基础。