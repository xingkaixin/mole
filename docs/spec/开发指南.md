# Mole 开发指南

## 项目概览

Mole 是基于 Wails 框架的桌面应用，用于数据库表的自动化分析。本指南将帮助开发者快速理解项目结构、开发环境搭建以及贡献代码。

## 技术栈

### 后端技术栈
- **Go 1.21+**: 主要后端开发语言
- **Wails v2**: 桌面应用开发框架
- **MySQL Driver**: `github.com/go-sql-driver/mysql`
- **SQLite Driver**: `github.com/mattn/go-sqlite3`

### 前端技术栈
- **React 18**: 用户界面框架
- **TypeScript**: 类型安全
- **Vite**: 构建工具
- **Tailwind CSS**: CSS框架
- **Shadcn UI**: UI组件库
- **Biome**: 代码格式化

## 开发环境搭建

### 前置要求
- Go 1.21+
- Node.js 18+
- Bun (推荐) 或 npm/yarn

### 1. 克隆项目
```bash
git clone <repository-url>
cd mole
```

### 2. 安装依赖
```bash
# 安装前端依赖
make deps

# 或者手动安装
cd frontend && bun install
```

### 3. 开发模式运行
```bash
# 启动开发服务器
make dev

# 或者使用 wails 命令
wails dev
```

## 项目结构

```
mole/
├── backend/                    # Go 后端代码
│   ├── app.go                 # 应用核心控制器
│   ├── analysis.go            # 分析引擎和规则
│   ├── connection_pool.go     # 数据库连接池
│   ├── database.go            # 数据库管理
│   ├── storage.go             # 本地存储管理
│   └── task.go                # 任务管理器
├── frontend/                   # React 前端代码
│   ├── src/
│   │   ├── components/        # 可复用组件
│   │   │   ├── ui/           # UI基础组件
│   │   │   └── forms/        # 表单组件
│   │   ├── pages/            # 页面组件
│   │   ├── types/            # TypeScript类型定义
│   │   └── lib/              # 工具函数
│   ├── public/               # 静态资源
│   └── package.json
├── docs/                      # 文档
├── tasks/                     # 任务规划
├── wails.json                 # Wails配置
├── main.go                    # 应用入口
├── go.mod                     # Go模块定义
└── Makefile                   # 构建脚本
```

## 开发规范

### Go 代码规范

#### 1. 命名规范
```go
// 结构体使用大驼峰
type DatabaseManager struct {
    config *DatabaseConfig
    db     *sql.DB
}

// 函数名使用大驼峰（公开）或小驼峰（私有）
func NewDatabaseManager() *DatabaseManager {
    return &DatabaseManager{}
}

func (dm *DatabaseManager) Connect(config *DatabaseConfig) error {
    // 实现
}

// 常量使用大驼峰
const (
    TaskStatusPending   TaskStatus = "pending"
    TaskStatusRunning   TaskStatus = "running"
    TaskStatusCompleted TaskStatus = "completed"
)
```

#### 2. 错误处理
```go
// 使用 fmt.Errorf 包装错误
if err != nil {
    return "", fmt.Errorf("failed to connect database: %w", err)
}

// 提供上下文信息
if err := db.Ping(); err != nil {
    return "", fmt.Errorf("connection test failed for %s: %w", config.Host, err)
}
```

#### 3. 接口设计
```go
// 接口命名以 -er 结尾
type AnalysisRule interface {
    GetName() string
    GetDescription() string
    Execute(db *sql.DB, tableName string, config *DatabaseConfig) (interface{}, error)
}

// 接口实现
type RowCountRule struct{}

func (r *RowCountRule) GetName() string {
    return "row_count"
}
```

### TypeScript 代码规范

#### 1. 组件定义
```typescript
// 使用函数式组件和 TypeScript 接口
interface DatabaseConfigFormProps {
  config: DatabaseConfig;
  isAdding: boolean;
  onConfigChange: (field: keyof DatabaseConfig, value: string | number) => void;
  onTestConnection: () => void;
  onSaveConnection: () => void;
  onBack: () => void;
  connectionStatus: string;
}

export const DatabaseConfigForm: React.FC<DatabaseConfigFormProps> = ({
  config,
  isAdding,
  onConfigChange,
  onTestConnection,
  onSaveConnection,
  onBack,
  connectionStatus
}) => {
  // 组件实现
};
```

#### 2. 类型定义
```typescript
// 接口定义使用清晰的类型
export interface DatabaseConfig {
  id: string;
  name: string;
  type: string;
  host: string;
  port: number;
  username: string;
  password: string;
  database: string;
  concurrency: number;
}

// 联合类型定义枚举值
export type TaskStatus = "pending" | "running" | "completed" | "failed" | "cancelled";
```

#### 3. 异步处理
```typescript
// 使用 async/await 和错误处理
const handleConnectDatabase = async (config: DatabaseConfig) => {
  try {
    const result = await ConnectDatabase(config);
    toast.success(result);
    setCurrentStep("analysis_tables");
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error);
    toast.error(message);
  }
};
```

## 核心模块开发

### 1. 添加新的分析规则

#### 步骤 1: 实现规则接口
```go
// 在 backend/analysis.go 中添加新规则
type CustomRule struct{}

func (r *CustomRule) GetName() string {
    return "custom_rule"
}

func (r *CustomRule) GetDescription() string {
    return "自定义分析规则"
}

func (r *CustomRule) Execute(db *sql.DB, tableName string, config *DatabaseConfig) (interface{}, error) {
    // 实现分析逻辑
    var result int64
    err := db.QueryRow(fmt.Sprintf("SELECT COUNT(*) FROM %s WHERE condition", tableName)).Scan(&result)
    if err != nil {
        return nil, fmt.Errorf("failed to execute custom rule: %w", err)
    }
    return result, nil
}
```

#### 步骤 2: 注册规则
```go
// 在 NewAnalysisEngine 函数中注册新规则
func NewAnalysisEngine() *AnalysisEngine {
    engine := &AnalysisEngine{
        rules: make(map[string]AnalysisRule),
    }

    // 注册默认规则
    engine.RegisterRule(&RowCountRule{})
    engine.RegisterRule(&NonNullRateRule{})
    engine.RegisterRule(&CustomRule{}) // 添加新规则

    return engine
}
```

### 2. 添加新的数据库支持

#### 步骤 1: 扩展数据库管理器
```go
// 在 backend/database.go 中添加新数据库支持
func (dm *DatabaseManager) Connect(config *DatabaseConfig) error {
    switch config.Type {
    case "mysql":
        return dm.connectMySQL(config)
    case "postgresql":
        return dm.connectPostgreSQL(config)
    default:
        return fmt.Errorf("unsupported database type: %s", config.Type)
    }
}

func (dm *DatabaseManager) connectPostgreSQL(config *DatabaseConfig) error {
    // PostgreSQL 连接逻辑
    dsn := fmt.Sprintf("host=%s port=%d user=%s password=%s dbname=%s sslmode=disable",
        config.Host, config.Port, config.Username, config.Password, config.Database)

    db, err := sql.Open("postgres", dsn)
    if err != nil {
        return fmt.Errorf("failed to open postgresql database: %w", err)
    }

    if err := db.Ping(); err != nil {
        db.Close()
        return fmt.Errorf("failed to ping postgresql database: %w", err)
    }

    dm.config = config
    dm.db = db
    return nil
}
```

### 3. 添加新页面组件

#### 步骤 1: 创建页面组件
```typescript
// 在 frontend/src/pages/ 中创建新组件
import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

export const NewFeaturePage: React.FC = () => {
  const [data, setData] = useState<any[]>([]);

  return (
    <div className="p-6">
      <Card>
        <CardHeader>
          <CardTitle>新功能页面</CardTitle>
        </CardHeader>
        <CardContent>
          {/* 页面内容 */}
        </CardContent>
      </Card>
    </div>
  );
};
```

#### 步骤 2: 添加路由
```typescript
// 在 App.tsx 中添加新页面路由
type AppStep = "welcome" | "config" | "analysis_tables" | "new_feature";

// 在组件渲染中添加
{currentStep === "new_feature" && <NewFeaturePage />}
```

## 构建和部署

### 1. 开发构建
```bash
# 开发模式
make dev

# 前端开发服务器
cd frontend && bun run dev
```

### 2. 生产构建
```bash
# 构建 macOS 应用
make build-mac

# 构建 Windows 应用
make build-windows

# 手动构建
wails build
```

### 3. 代码质量检查
```bash
# 格式化代码
make format

# 代码检查
make lint

# 自动修复
make check
```

## 测试指南

### 1. 后端测试
```go
// 创建测试文件 backend/database_test.go
package backend

import (
    "testing"
)

func TestDatabaseManager_Connect(t *testing.T) {
    dm := NewDatabaseManager()
    config := &DatabaseConfig{
        Type:     "mysql",
        Host:     "localhost",
        Port:     3306,
        Username: "test",
        Password: "test",
        Database: "test_db",
    }

    err := dm.Connect(config)
    if err != nil {
        t.Errorf("Expected no error, got %v", err)
    }
}
```

### 2. 前端测试
```typescript
// 创建测试文件 frontend/src/components/__tests__/DatabaseConfigForm.test.tsx
import { render, screen } from '@testing-library/react';
import { DatabaseConfigForm } from '../forms/DatabaseConfigForm';

test('renders database config form', () => {
  const mockProps = {
    config: { /* mock config */ },
    isAdding: true,
    onConfigChange: jest.fn(),
    onTestConnection: jest.fn(),
    onSaveConnection: jest.fn(),
    onBack: jest.fn(),
    connectionStatus: ''
  };

  render(<DatabaseConfigForm {...mockProps} />);

  expect(screen.getByLabelText('连接名称')).toBeInTheDocument();
});
```

## 调试技巧

### 1. 后端调试
```go
// 使用 fmt.Printf 调试
fmt.Printf("Connecting to database with config: %+v\n", config)

// 使用 log 包
log.Printf("Analysis task started: %s", task.ID)

// 条件编译调试
if os.Getenv("DEBUG") != "" {
    fmt.Printf("Debug: task status = %s\n", task.Status)
}
```

### 2. 前端调试
```typescript
// 使用 console.log
console.log("Current step:", currentStep);

// 使用 React DevTools
// 安装 React Developer Tools 浏览器扩展

// 使用 Wails 开发者工具
// Wails dev 模式下有内置的开发者工具
```

## 性能优化

### 1. 后端优化
- 使用连接池管理数据库连接
- 实现查询结果缓存
- 优化 SQL 查询语句
- 合理设置并发数

### 2. 前端优化
- 使用 React.memo 避免不必要的重渲染
- 实现虚拟滚动处理大列表
- 使用防抖节流优化频繁操作
- 懒加载组件和资源

## 常见问题

### 1. 数据库连接问题
```go
// 确保正确关闭数据库连接
defer db.Close()

// 设置连接超时
db.SetConnMaxLifetime(time.Hour)
db.SetMaxOpenConns(10)
```

### 2. 前端状态管理
```typescript
// 使用 useCallback 避免函数重新创建
const handleSubmit = useCallback(async () => {
    // 提交逻辑
}, [dependencies]);

// 使用 useMemo 缓存计算结果
const expensiveValue = useMemo(() => {
    return computeExpensiveValue(data);
}, [data]);
```

### 3. 构建问题
```bash
# 清理构建缓存
wails build -clean

# 重新安装依赖
rm -rf node_modules package-lock.json
bun install

# 检查 Go 模块
go mod tidy
go mod download
```

## 贡献指南

1. **Fork 项目** 并创建功能分支
2. **编写代码** 并遵循代码规范
3. **添加测试** 确保功能正常
4. **更新文档** 包括 API 文档和用户文档
5. **提交 PR** 并描述变更内容

### 提交信息规范
```
feat: 添加新功能
fix: 修复问题
docs: 更新文档
style: 代码格式调整
refactor: 代码重构
test: 添加测试
chore: 构建工具或辅助工具的变动
```

这个开发指南为开发者提供了完整的开发环境搭建、代码规范、核心模块开发以及调试优化的指导，确保团队成员能够高效地参与项目开发。