# Mole 部署指南

## 概述

Mole 是基于 Wails 框架的桌面应用程序，支持跨平台部署。本指南详细介绍了如何为不同平台构建、打包和分发 Mole 应用程序。

## 支持的平台

- **macOS**: Intel (x86_64) 和 Apple Silicon (arm64)
- **Windows**: 64位 (x86_64)
- **Linux**: 64位 (x86_64)

## 构建环境要求

### 通用要求
- Go 1.23+
- Node.js 18+
- Wails v2 CLI

### 平台特定要求

#### macOS
```bash
# 安装 Xcode Command Line Tools
xcode-select --install

# 如果没有安装 Go
brew install go

# 安装 Node.js (推荐使用 fnm)
curl -fsSL https://fnm.vercel.app/install | bash
fnm install 18
fnm use 18
```

#### Windows
```bash
# 使用 Chocolatey 或 Scoop 安装依赖
# Chocolatey
choco install golang nodejs

# 或使用 Scoop
scoop install go nodejs

# 安装 Wails
go install github.com/wailsapp/wails/v2/cmd/wails@latest
```

#### Linux (Ubuntu/Debian)
```bash
# 安装构建依赖
sudo apt update
sudo apt install build-essential libgtk-3-dev libwebkit2gtk-4.0-dev

# 安装 Go
wget https://go.dev/dl/go1.23.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

## 构建配置

### Wails 配置文件 (wails.json)

```json
{
  "$schema": "https://wails.io/schemas/config.v2.json",
  "name": "mole",
  "outputfilename": "mole",
  "frontend:install": "bun install",
  "frontend:build": "bun run build",
  "frontend:dev:watcher": "bun run dev",
  "frontend:dev:serverUrl": "auto",
  "wailsjsdir": "./frontend",
  "author": {
    "name": "XingKaiXin",
    "email": "xingkaixin@gmail.com",
    "url": "https://github.com/xingkaixin"
  }
}
```

### Makefile 构建脚本

```makefile
.PHONY: dev build-windows build-mac clean deps lint format check help

# Run the application in development mode
dev:
	wails dev

# Build the application for Windows
build-windows:
	wails build -platform windows/amd64


# Build the application for macOS
build-mac:
	wails build -platform darwin/universal

# Clean build artifacts
clean:
	rm -rf build/bin
	cd frontend && rm -rf dist

# Install frontend dependencies
deps:
	cd frontend && bun install

# Lint frontend code
lint:
	cd frontend && bun run lint

# Format frontend code
format:
	cd frontend && bun run format

# Check frontend code
check:
	cd frontend && bun run check

# Help command to show available targets
help:
	@echo "Available commands:"
	@echo "  make dev           - Run the application in development mode"
	@echo "  make build-windows - Build the application for Windows (64-bit)"
	@echo "  make build-linux   - Build the application for Linux (64-bit)"
	@echo "  make build-mac     - Build the application for macOS (universal)"
	@echo "  make clean         - Clean build artifacts"
	@echo "  make lint          - Lint frontend code"
	@echo "  make format        - Format frontend code"
	@echo "  make check         - Check and apply fixes to frontend code"
```

## 构建流程

### 1. 环境准备
```bash
# 克隆项目
git clone <repository-url>
cd mole

# 安装依赖
make deps

# 验证环境
wails doctor
```

### 2. 开发构建
```bash
# 开发模式运行
make dev

# 或直接使用 wails 命令
wails dev
```

### 3. 生产构建

#### macOS 构建
```bash
# 构建 Intel 版本
wails build -platform darwin/amd64

# 构建 Apple Silicon 版本
wails build -platform darwin/arm64

# 构建通用二进制文件
wails build -platform darwin/universal

# 使用 Makefile
make build-mac
```

#### Windows 构建
```bash
# 构建 Windows 版本
wails build -platform windows/amd64

# 或使用 Makefile
make build-windows
```

#### Linux 构建
```bash
# 构建 Linux 版本
wails build -platform linux/amd64

# 或使用 Makefile
make build-linux
```

## 应用程序打包

### macOS 打包

#### 1. 创建 DMG 安装包
```bash
# 安装 create-dmg 工具
brew install create-dmg

# 创建 DMG
create-dmg \
  --volname "Mole" \
  --window-pos 200 120 \
  --window-size 600 300 \
  --icon-size 100 \
  --icon "build/bin/mole.app" 175 120 \
  --hide-extension "mole.app" \
  --app-drop-link 425 120 \
  "Mole.dmg" \
  "build/bin/"
```

#### 2. 代码签名 (发布时)
```bash
# 设置开发者证书
export DEVELOPER_ID="Developer ID Application: Your Name (TEAM_ID)"

# 签名应用程序
codesign --force --verify --verbose --sign "$DEVELOPER_ID" build/bin/mole.app

# 验证签名
codesign --verify --verbose build/bin/mole.app
```

#### 3. 公证 (App Store)
```bash
# 上传公证
xcrun altool --notarize-app \
  --primary-bundle-id "com.yourcompany.mole" \
  --username "your@email.com" \
  --password "@keychain:AC_PASSWORD" \
  --file "Mole.dmg"
```

### Windows 打包

#### 1. 创建安装程序
```bash
# 使用 NSIS 或 Inno Setup 创建安装程序

# NSIS 脚本示例 (installer.nsi)
!define APPNAME "Mole"
!define VERSION "1.0.0"
!define PUBLISHER "Your Company"

Name "${APPNAME}"
OutFile "${APPNAME}_Setup_${VERSION}.exe"
InstallDir "$PROGRAMFILES\${APPNAME}"

Section "MainSection" SEC01
    SetOutPath "$INSTDIR"
    File /r "build\bin\*"
    CreateShortCut "$DESKTOP\${APPNAME}.lnk" "$INSTDIR\mole.exe"
SectionEnd
```

#### 2. 代码签名
```bash
# 使用 signtool 签名
signtool sign /f certificate.p12 /p password /t http://timestamp.digicert.com mole.exe
```

### Linux 打包

#### 1. 创建 AppImage
```bash
# 下载 appimagetool
wget https://github.com/AppImage/appimagetool/releases/downloadcontinuous/appimagetool-x86_64.AppImage
chmod +x appimagetool-x86_64.AppImage

# 创建 AppImage 目录
mkdir -p Mole.AppDir/usr/bin
cp build/bin/mole Mole.AppDir/usr/bin/

# 创建 Desktop 文件
cat > Mole.AppDir/mole.desktop << EOF
[Desktop Entry]
Type=Application
Name=Mole
Exec=mole
Icon=mole
Categories=Development;
EOF

# 创建 AppImage
./appimagetool-x86_64.AppImage Mole.AppDir Mole.AppImage
```

#### 2. 创建 DEB 包 (Ubuntu/Debian)
```bash
# 创建目录结构
mkdir -p mole-package/DEBIAN
mkdir -p mole-package/usr/bin
mkdir -p mole-package/usr/share/applications
mkdir -p mole-package/usr/share/icons/hicolor/256x256/apps

# 复制文件
cp build/bin/mole mole-package/usr/bin/
cp mole.desktop mole-package/usr/share/applications/
cp mole.png mole-package/usr/share/icons/hicolor/256x256/apps/

# 创建控制文件
cat > mole-package/DEBIAN/control << EOF
Package: mole
Version: 1.0.0
Section: development
Priority: optional
Architecture: amd64
Depends: libc6, libgtk-3-0, libwebkit2gtk-4.0-37
Maintainer: Your Name <your@email.com>
Description: Database table analysis tool
EOF

# 构建 DEB 包
dpkg-deb --build mole-package mole_1.0.0_amd64.deb
```

## 持续集成/持续部署 (CI/CD)

### GitHub Actions 配置

#### 1. 构建工作流 (.github/workflows/build.yml)
```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: mole-linux
            asset_name: mole-linux-amd64
          - os: windows-latest
            artifact_name: mole-windows.exe
            asset_name: mole-windows-amd64.exe
          - os: macos-latest
            artifact_name: mole-mac
            asset_name: mole-mac-universal

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Wails
      run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm install

    - name: Build
      run: wails build -platform ${{ matrix.os }}/amd64

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: build/bin/*

    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/bin/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

#### 2. 代码质量检查 (.github/workflows/quality.yml)
```yaml
name: Code Quality

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        go mod download
        cd frontend && npm install

    - name: Run tests
      run: |
        go test ./...
        cd frontend && npm test

    - name: Lint
      run: |
        go vet ./...
        cd frontend && npm run lint
```

## 版本管理

### 1. 语义化版本
```
主版本.次版本.修订版本 (MAJOR.MINOR.PATCH)

示例:
- 1.0.0 - 首次发布
- 1.1.0 - 新功能
- 1.1.1 - 修复 bug
- 2.0.0 - 重大更新
```

### 2. 版本标签
```bash
# 创建版本标签
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# 查看标签
git tag -l

# 删除标签
git tag -d v1.0.0
git push origin :refs/tags/v1.0.0
```

### 3. 自动版本号
```go
// 在构建时注入版本信息
// build/version.go
package build

var (
    Version   = "dev"
    GitCommit = "unknown"
    BuildTime = "unknown"
)

// 在 main.go 中使用
func main() {
    if build.Version == "dev" {
        log.Printf("Development build - %s", build.GitCommit)
    } else {
        log.Printf("Mole version %s (built %s)", build.Version, build.BuildTime)
    }
}
```

## 分发策略

### 1. 自动分发
- GitHub Releases
- 官方网站下载
- 包管理器 (Homebrew, Chocolatey, APT)

### 2. Homebrew Formula (macOS)
```ruby
# Formula/mole.rb
class Mole < Formula
  desc "Database table analysis tool"
  homepage "https://github.com/yourusername/mole"
  url "https://github.com/yourusername/mole/releases/download/v1.0.0/mole-mac-universal.tar.gz"
  sha256 "your_sha256_hash"

  depends_on "webkit2gtk"

  def install
    bin.install "mole"
  end

  test do
    system "#{bin}/mole", "--version"
  end
end
```

### 3. Chocolatey Package (Windows)
```xml
<!-- tools/chocolatey/mole.nuspec -->
<?xml version="1.0" encoding="utf-8"?>
<package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
  <metadata>
    <id>mole</id>
    <version>1.0.0</version>
    <packageSourceUrl>https://github.com/yourusername/mole</packageSourceUrl>
    <owners>Your Name</owners>
    <title>Mole</title>
    <authors>Your Name</authors>
    <projectUrl>https://github.com/yourusername/mole</projectUrl>
    <iconUrl>https://raw.githubusercontent.com/yourusername/mole/main/icon.png</iconUrl>
    <copyright>2024 Your Company</copyright>
    <licenseUrl>https://github.com/yourusername/mole/blob/main/LICENSE</licenseUrl>
    <requireLicenseAcceptance>false</requireLicenseAcceptance>
    <projectSourceUrl>https://github.com/yourusername/mole</projectSourceUrl>
    <docsUrl>https://github.com/yourusername/mole/blob/main/docs/README.md</docsUrl>
    <bugTrackerUrl>https://github.com/yourusername/mole/issues</bugTrackerUrl>
    <tags>database analysis tool</tags>
    <summary>Database table analysis tool</summary>
    <description>A desktop application for analyzing database tables.</description>
  </metadata>
  <files>
    <file src="mole.exe" target="tools" />
  </files>
</package>
```

## 更新机制

### 1. 自动更新检查
```go
// backend/update.go
package backend

import (
    "encoding/json"
    "net/http"
)

type ReleaseInfo struct {
    Version string `json:"tag_name"`
    Assets  []struct {
        Name string `json:"name"`
        URL  string `json:"browser_download_url"`
    } `json:"assets"`
}

func CheckForUpdates(currentVersion string) (*ReleaseInfo, error) {
    resp, err := http.Get("https://api.github.com/repos/yourusername/mole/releases/latest")
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()

    var release ReleaseInfo
    if err := json.NewDecoder(resp.Body).Decode(&release); err != nil {
        return nil, err
    }

    if release.Version > currentVersion {
        return &release, nil
    }

    return nil, nil
}
```

### 2. 前端更新提示
```typescript
// frontend/src/components/UpdateChecker.tsx
import { useEffect, useState } from 'react';
import { CheckForUpdates } from '../wailsjs/go/backend/App';

export const UpdateChecker: React.FC = () => {
    const [updateAvailable, setUpdateAvailable] = useState(false);

    useEffect(() => {
        const checkUpdates = async () => {
            try {
                const release = await CheckForUpdates();
                setUpdateAvailable(!!release);
            } catch (error) {
                console.error('Failed to check updates:', error);
            }
        };

        checkUpdates();
    }, []);

    if (!updateAvailable) return null;

    return (
        <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
                新版本可用！请访问 GitHub 下载最新版本。
            </p>
        </div>
    );
};
```

## 故障排除

### 1. 构建失败
```bash
# 清理构建缓存
wails build -clean
rm -rf frontend/node_modules frontend/dist

# 重新安装依赖
go mod tidy
cd frontend && npm install

# 检查环境
wails doctor
```

### 2. 运行时问题
```bash
# 检查依赖
ldd mole  # Linux
otool -L mole  # macOS

# 检查权限
chmod +x mole

# 调试模式运行
./mole --debug
```

### 3. 平台特定问题

#### macOS
```bash
# 公证问题
xcrun altool --notarization-info <request-uuid> -u "your@email.com"

# 权限问题
codesign --verify --verbose mole.app
```

#### Windows
```bash
# DLL 依赖问题
dumpbin /dependents mole.exe

# 安装 Visual C++ Redistributable
```

#### Linux
```bash
# 依赖检查
ldd mole
apt-get install -f  # 修复依赖
```

这个部署指南提供了完整的构建、打包和分发流程，确保 Mole 应用程序能够在各个平台上正确部署和运行。