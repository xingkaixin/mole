# Mole 数据库设计文档

## 数据库架构概览

Mole 系统采用双数据库架构设计：
1. **外部数据库**: 用户配置的目标数据库（如 MySQL），用于分析操作
2. **内部数据库**: SQLite 本地数据库，用于存储应用配置和分析结果

## 内部数据库设计 (SQLite)

### 数据库位置
- **Windows**: `%APPDATA%\Mole\mole.db`
- **macOS**: `~/Library/Application Support/Mole/mole.db`
- **Linux**: `~/.local/share/mole/mole.db`

### 表结构设计

#### 1. database_connections 表
**用途**: 存储数据库连接配置信息

```sql
CREATE TABLE database_connections (
    id TEXT PRIMARY KEY,                    -- 连接唯一标识
    name TEXT NOT NULL,                     -- 连接名称 (用户友好显示)
    type TEXT NOT NULL,                     -- 数据库类型 (mysql, postgresql等)
    host TEXT NOT NULL,                     -- 数据库主机地址
    port INTEGER NOT NULL,                  -- 数据库端口号
    username TEXT NOT NULL,                 -- 数据库用户名
    password TEXT NOT NULL,                 -- 数据库密码 (存储时需要考虑加密)
    database TEXT NOT NULL,                 -- 数据库名称
    concurrency INTEGER DEFAULT 5,          -- 并发度配置
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 创建时间
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP   -- 更新时间
);
```

**字段说明**:
- `id`: 唯一标识符，通常使用时间戳生成
- `type`: 当前支持 "mysql"，预留扩展其他数据库类型
- `concurrency`: 控制分析任务的并发数，默认值为 5
- `password`: 敏感信息，生产环境建议加密存储

**索引设计**:
```sql
CREATE INDEX idx_database_connections_name ON database_connections(name);
CREATE INDEX idx_database_connections_type ON database_connections(type);
```

#### 2. table_selections 表
**用途**: 存储用户选择的表信息，支持持久化表选择状态

```sql
CREATE TABLE table_selections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,   -- 自增主键
    connection_id TEXT NOT NULL,            -- 关联的数据库连接ID
    table_name TEXT NOT NULL,               -- 表名
    selected BOOLEAN NOT NULL DEFAULT 0,    -- 是否选中 (0: 未选中, 1: 选中)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 创建时间
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 更新时间
    UNIQUE(connection_id, table_name),      -- 联合唯一约束
    FOREIGN KEY (connection_id) REFERENCES database_connections(id) ON DELETE CASCADE
);
```

**约束说明**:
- `UNIQUE(connection_id, table_name)`: 确保同一连接下的表名唯一
- `FOREIGN KEY`: 外键约束，级联删除
- `selected`: 使用布尔类型，SQLite 中存储为 INTEGER (0/1)

**索引设计**:
```sql
CREATE INDEX idx_table_selections_connection_id ON table_selections(connection_id);
CREATE INDEX idx_table_selections_selected ON table_selections(selected);
```

#### 3. analysis_results 表
**用途**: 存储分析任务的执行结果

```sql
CREATE TABLE analysis_results (
    id TEXT PRIMARY KEY,                    -- 分析结果唯一标识
    connection_id TEXT NOT NULL,            -- 关联的数据库连接ID
    table_name TEXT NOT NULL,               -- 被分析的表名
    rules TEXT NOT NULL,                    -- 应用的分析规则 (JSON格式)
    results TEXT NOT NULL,                  -- 分析结果数据 (JSON格式)
    status TEXT NOT NULL,                   -- 分析状态
    started_at DATETIME NOT NULL,           -- 开始时间
    completed_at DATETIME,                  -- 完成时间 (可为空)
    duration INTEGER,                       -- 执行时长 (秒)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 创建时间
    FOREIGN KEY (connection_id) REFERENCES database_connections(id) ON DELETE CASCADE
);
```

**字段详细说明**:

- `id`: 格式通常为 "result_{tablename}_{timestamp}"
- `rules`: JSON 数组，存储使用的分析规则列表
  ```json
  ["row_count", "non_null_rate"]
  ```
- `results`: JSON 对象，存储具体的分析结果数据
  ```json
  {
    "row_count": 1000,
    "non_null_rate": {
      "id": 1.0,
      "name": 0.95,
      "email": 0.87
    }
  }
  ```
- `status`: 枚举值 (pending, running, completed, failed, cancelled)
- `duration`: 执行时长，单位为秒

**索引设计**:
```sql
CREATE INDEX idx_analysis_results_connection_id ON analysis_results(connection_id);
CREATE INDEX idx_analysis_results_table_name ON analysis_results(table_name);
CREATE INDEX idx_analysis_results_status ON analysis_results(status);
CREATE INDEX idx_analysis_results_started_at ON analysis_results(started_at);
```

### 数据关系图

```
database_connections (1) -----> (N) table_selections
                     |
                     |
                     +-----> (N) analysis_results
```

### 完整的表创建语句

```sql
-- 创建数据库连接配置表
CREATE TABLE IF NOT EXISTS database_connections (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL,
    host TEXT NOT NULL,
    port INTEGER NOT NULL,
    username TEXT NOT NULL,
    password TEXT NOT NULL,
    database TEXT NOT NULL,
    concurrency INTEGER DEFAULT 5,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 创建表选择状态表
CREATE TABLE IF NOT EXISTS table_selections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    connection_id TEXT NOT NULL,
    table_name TEXT NOT NULL,
    selected BOOLEAN NOT NULL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(connection_id, table_name),
    FOREIGN KEY (connection_id) REFERENCES database_connections(id) ON DELETE CASCADE
);

-- 创建分析结果表
CREATE TABLE IF NOT EXISTS analysis_results (
    id TEXT PRIMARY KEY,
    connection_id TEXT NOT NULL,
    table_name TEXT NOT NULL,
    rules TEXT NOT NULL,
    results TEXT NOT NULL,
    status TEXT NOT NULL,
    started_at DATETIME NOT NULL,
    completed_at DATETIME,
    duration INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (connection_id) REFERENCES database_connections(id) ON DELETE CASCADE
);
```

## 外部数据库交互设计

### 支持的数据库类型
当前主要支持 **MySQL**，设计预留扩展其他数据库类型：

```go
// DatabaseConfig 中的 type 字段支持：
- "mysql"     - MySQL/MariaDB
- "postgresql" - PostgreSQL (预留)
- "sqlite"    - SQLite (预留)
- "oracle"    - Oracle (预留)
```

### MySQL 元数据查询

#### 1. 获取表列表
```sql
SHOW TABLES;
```

#### 2. 获取表结构信息
```sql
SHOW COLUMNS FROM table_name;
```

#### 3. 获取表统计信息
```sql
-- 获取行数
SELECT COUNT(*) FROM table_name;

-- 获取数据大小和索引大小
SELECT
    data_length + index_length as total_size,
    data_length,
    index_length
FROM information_schema.tables
WHERE table_schema = ? AND table_name = ?;

-- 获取表注释
SELECT table_comment
FROM information_schema.tables
WHERE table_schema = ? AND table_name = ?;

-- 获取列信息
SELECT COUNT(*)
FROM information_schema.columns
WHERE table_schema = ? AND table_name = ?;
```

### 数据库连接池设计

#### 连接池参数
```go
type ConnectionPool struct {
    maxOpenConns    int           // 最大打开连接数
    maxIdleConns    int           // 最大空闲连接数
    connMaxLifetime time.Duration // 连接最大生存时间
    connMaxIdleTime time.Duration // 连接最大空闲时间
}
```

#### 默认配置
```go
maxOpenConns: 10
maxIdleConns: 5
connMaxLifetime: 1 * time.Hour
connMaxIdleTime: 30 * time.Minute
```

## 数据迁移和版本管理

### 版本控制策略
使用 SQLite 的 `PRAGMA user_version` 管理数据库版本：

```sql
-- 检查当前版本
PRAGMA user_version;

-- 设置版本号
PRAGMA user_version = 1;
```

### 迁移脚本示例
```go
func migrateDatabase(db *sql.DB) error {
    var version int
    db.QueryRow("PRAGMA user_version").Scan(&version)

    if version < 1 {
        // 创建初始表结构
        createTables(db)
        db.Exec("PRAGMA user_version = 1")
    }

    if version < 2 {
        // 添加新字段或表
        addNewFields(db)
        db.Exec("PRAGMA user_version = 2")
    }

    return nil
}
```

## 性能优化策略

### 1. 索引优化
- 为常用查询字段创建索引
- 复合索引优化联合查询
- 定期分析索引使用情况

### 2. 查询优化
- 使用预编译语句 (prepared statements)
- 批量操作减少数据库往返
- 合理使用事务

### 3. 连接池优化
- 根据并发需求调整连接池大小
- 监控连接池使用情况
- 及时释放空闲连接

### 4. 存储优化
- JSON 数据压缩存储
- 大结果集分页处理
- 历史数据定期清理

## 数据备份和恢复

### 备份策略
```bash
# SQLite 备份
sqlite3 mole.db ".backup mole_backup_$(date +%Y%m%d_%H%M%S).db"

# 增量备份 (通过 WAL 模式)
PRAGMA journal_mode = WAL;
```

### 恢复策略
```bash
# 恢复备份
sqlite3 mole.db ".restore mole_backup_20240101_120000.db"
```

## 安全考虑

### 1. 敏感数据保护
- 数据库密码加密存储
- 使用系统密钥库存储敏感信息
- 内存中密码及时清理

### 2. 访问控制
- 数据库文件权限控制
- 应用程序权限最小化
- 审计日志记录

### 3. SQL 注入防护
- 使用参数化查询
- 输入验证和清理
- 错误信息脱敏

## 监控和维护

### 1. 性能监控
```sql
-- 查看表统计信息
SELECT
    name,
    sql,
    COUNT(*) as usage_count
FROM sqlite_master
WHERE type = 'index'
GROUP BY name, sql;
```

### 2. 存储监控
```sql
-- 查看数据库文件大小
.database

-- 查看表大小
SELECT
    name,
    COUNT(*) as row_count
FROM sqlite_master
WHERE type = 'table';
```

### 3. 定期维护
```sql
-- 清理数据库
VACUUM;

-- 重建索引
REINDEX;

-- 分析统计信息
ANALYZE;
```

## 扩展性设计

### 1. 新表结构预留
```sql
-- 预留扩展表
CREATE TABLE IF NOT EXISTS analysis_rules (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    config TEXT,  -- JSON配置
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS analysis_schedules (
    id TEXT PRIMARY KEY,
    connection_id TEXT,
    rule_config TEXT,
    schedule_config TEXT,  -- cron表达式等
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 水平扩展支持
- 分区表设计
- 分片策略预留
- 分布式存储接口

这个数据库设计为 Mole 应用提供了稳定可靠的数据存储基础，支持应用的核心功能需求，并为未来的功能扩展预留了空间。